name: Build Flutter APK and IPA on Release

on:
  release:
    types: [created]

jobs:
  android:
    name: Build Flutter APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get commit ID
        id: vars
        run: echo "COMMIT_ID=$(git rev-parse HEAD)" >> $GITHUB_ENV

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.35.7"

      - name: Install dependencies
        run: flutter pub get

      - name: Build release APK
        run: flutter build apk --release --dart-define=GIT_COMMIT=$COMMIT_ID

      - name: Upload APK to release assets
        uses: softprops/action-gh-release@v2
        with:
          files: build/app/outputs/flutter-apk/app-release.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  ios:
    name: Build Flutter IPA (unsigned)
    runs-on: macos-latest
  
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get commit ID
        id: vars
        run: echo "COMMIT_ID=$(git rev-parse HEAD)" >> $GITHUB_ENV
  
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.35.7"
  
      - name: Install dependencies
        run: flutter pub get
  
      - name: Build XCArchive (unsigned)
        run: flutter build ipa --no-codesign --release --dart-define=GIT_COMMIT=$COMMIT_ID
  
      - name: Create IPA manually
        run: |
          ARCHIVE_PATH="build/ios/archive/Runner.xcarchive"
  
          echo "Extracting .app…"
          APP_PATH="$ARCHIVE_PATH/Products/Applications/Runner.app"
  
          mkdir -p Payload
          cp -R "$APP_PATH" Payload/
  
          echo "Creating IPA…"
          zip -r Runner-unsigned.ipa Payload
  
          mkdir -p build/ios/ipa
          mv Runner-unsigned.ipa build/ios/ipa/
  
          ls -lh build/ios/ipa
  
      - name: Upload unsigned IPA
        uses: softprops/action-gh-release@v2
        with:
          files: build/ios/ipa/*.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
